<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SÅ«perLight</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "SF Mono", "Monaco", "Inconsolata", "Roboto Mono", monospace;
        background: #f5f5f5;
        height: 100vh;
        margin: 0;
        padding: 0;
        color: #333;
        overflow: hidden;
      }

      .container {
        background: #e8e8e8;
        border-radius: 0;
        box-shadow: none;
        padding: 0;
        width: 100vw;
        height: 100vh;
        margin: 0;
        display: flex;
        flex-direction: column;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0;
        padding: 16px 24px;
        border-bottom: 1px solid #d0d0d0;
        background: #e8e8e8;
        flex-shrink: 0;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo h1 {
        font-size: 16px;
        font-weight: 400;
        color: #333;
        letter-spacing: 0.5px;
      }

      .logo-icon {
        width: 20px;
        height: 20px;
        background: #333;
        border-radius: 2px;
      }

      .tagline {
        font-size: 10px;
        color: #666;
        font-weight: 300;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .nav-buttons {
        display: flex;
        gap: 2px;
      }

      .nav-btn {
        padding: 8px 16px;
        background: #f0f0f0;
        border: 1px solid #d0d0d0;
        color: #333;
        font-size: 11px;
        font-weight: 400;
        cursor: pointer;
        transition: all 0.15s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-family: inherit;
      }

      .nav-btn:first-child {
        border-radius: 4px 0 0 4px;
      }

      .nav-btn:last-child {
        border-radius: 0 4px 4px 0;
      }

      .nav-btn.active {
        background: #ff6b35;
        border-color: #e55a2b;
        color: #fff;
      }

      .nav-btn:hover {
        background: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .nav-btn.active:hover {
        background: #ff7849;
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
      }

      .nav-btn:active {
        background: #e0e0e0;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0;
        padding: 16px 24px;
        border-bottom: 1px solid #d0d0d0;
        background: #e8e8e8;
        flex-shrink: 0;
      }

      .toolbar-left,
      .toolbar-right {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .file-input {
        position: relative;
        overflow: hidden;
        display: inline-block;
      }

      .file-input input[type="file"] {
        position: absolute;
        left: -9999px;
      }

      .file-input label {
        padding: 10px 16px;
        background: #f8f8f8;
        border: 1px solid #d0d0d0;
        border-radius: 4px;
        color: #333;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.15s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-family: inherit;
        font-weight: 400;
      }

      .file-input label:hover {
        background: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .btn {
        padding: 10px 16px;
        background: #f8f8f8;
        border: 1px solid #d0d0d0;
        border-radius: 4px;
        color: #333;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.15s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-family: inherit;
        font-weight: 400;
      }

      .btn.action {
        background: #ff6b35;
        border-color: #e55a2b;
        color: #fff;
      }

      .btn.action:hover {
        background: #ff7849;
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
      }

      .btn:hover {
        background: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .btn:active {
        transform: translateY(1px);
      }

      .char-count {
        font-size: 10px;
        color: #666;
        padding: 8px 12px;
        background: #f0f0f0;
        border: 1px solid #d0d0d0;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-family: inherit;
      }

      .editor-container {
        display: flex;
        gap: 0;
        height: calc(100vh - 170px);
        flex: 1;
      }

      .editor-panel {
        flex: 0 0 45%;
        background: #fff;
        border-right: 1px solid #d0d0d0;
        padding: 24px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        overflow-y: auto;
      }

      .editor-textarea {
        width: 100%;
        height: 100%;
        background: transparent;
        border: none;
        outline: none;
        font-family: "SF Mono", "Monaco", "Inconsolata", "Roboto Mono", monospace;
        font-size: 13px;
        color: #333;
        resize: none;
        line-height: 1.6;
        font-weight: 400;
      }

      .editor-textarea::placeholder {
        color: #999;
        font-weight: 300;
      }

      .preview-panel {
        flex: 1;
        background: #fafafa;
        border: none;
        border-left: 1px solid #d0d0d0;
        padding: 24px;
        overflow-y: auto;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }

      /* GitHub-style markdown rendering */
      .preview-panel h1,
      .preview-panel h2,
      .preview-panel h3,
      .preview-panel h4,
      .preview-panel h5,
      .preview-panel h6 {
        color: #333;
        margin-top: 24px;
        margin-bottom: 16px;
        font-weight: 600;
        line-height: 1.25;
      }

      .preview-panel h1 {
        border-bottom: 1px solid #d0d7de;
        padding-bottom: 0.3em;
      }

      .preview-panel h2 {
        border-bottom: 1px solid #d0d7de;
        padding-bottom: 0.3em;
      }

      .preview-panel p {
        margin-bottom: 16px;
      }

      .preview-panel code {
        background-color: #f6f8fa;
        color: #24292e;
        border-radius: 6px;
        padding: 0.2em 0.4em;
        font-size: 85%;
        font-family: ui-monospace, SFMono-Regular, "SF Mono", Consolas, "Liberation Mono", Menlo, Courier, monospace;
      }

      .preview-panel pre {
        background-color: #f6f8fa;
        color: #24292e;
        border-radius: 6px;
        padding: 16px;
        overflow: auto;
        font-size: 14px;
        line-height: 1.45;
        margin: 16px 0;
        font-family: ui-monospace, SFMono-Regular, "SF Mono", Consolas, "Liberation Mono", Menlo, Courier, monospace;
      }

      .preview-panel pre code {
        background: transparent;
        color: inherit;
        padding: 0;
        border-radius: 0;
        font-size: inherit;
        line-height: inherit;
        border: none;
        box-shadow: none;
        display: block;
      }

      .preview-panel a {
        color: #0969da;
        text-decoration: none;
      }

      .preview-panel a:hover {
        text-decoration: underline;
      }

      .preview-panel ul,
      .preview-panel ol {
        margin-bottom: 16px;
        padding-left: 2em;
      }

      .preview-panel li {
        margin-bottom: 0.25em;
      }

      .preview-panel blockquote {
        padding: 0 1em;
        color: #656d76;
        border-left: 0.25em solid #d0d7de;
        margin: 0 0 16px 0;
      }

      .preview-panel hr {
        height: 0.25em;
        padding: 0;
        margin: 24px 0;
        background-color: #d0d7de;
        border: 0;
      }

      .preview-panel img {
        max-width: 100%;
        height: auto;
        border-radius: 6px;
        margin: 8px 0;
      }

      .preview-panel table {
        border-collapse: collapse;
        border-spacing: 0;
        width: 100%;
        margin-bottom: 16px;
        border: 1px solid #d0d7de;
      }

      .preview-panel th,
      .preview-panel td {
        padding: 6px 13px;
        border: 1px solid #d0d7de;
        text-align: left;
      }

      .preview-panel th {
        background-color: #f6f8fa;
        font-weight: 600;
      }

      .preview-panel tr:nth-child(2n) {
        background-color: #f6f8fa;
      }

      /* Layout states */
      .container[data-layout="code"] .preview-panel {
        display: none;
      }

      .container[data-layout="preview"] .editor-panel {
        display: none;
      }

      /* Clean scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f0f0f0;
      }

      ::-webkit-scrollbar-thumb {
        background: #c0c0c0;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #a0a0a0;
      }

      /* Focus states for accessibility */
      .btn:focus,
      .nav-btn:focus,
      .file-input label:focus {
        outline: 2px solid #ff6b35;
        outline-offset: 2px;
      }

      .editor-textarea:focus {
        box-shadow: inset 0 0 0 2px #ff6b35;
      }

      /* Import Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
      }

      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow: hidden;
        transform: scale(0.9);
        transition: transform 0.2s ease;
      }

      .modal-overlay.active .modal {
        transform: scale(1);
      }

      .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #d0d0d0;
        background: #f8f8f8;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin: 0;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #666;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.15s ease;
      }

      .modal-close:hover {
        background: #e0e0e0;
        color: #333;
      }

      .modal-tabs {
        display: flex;
        border-bottom: 1px solid #d0d0d0;
        background: #f8f8f8;
      }

      .modal-tab {
        flex: 1;
        padding: 12px 16px;
        background: none;
        border: none;
        color: #666;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-family: inherit;
      }

      .modal-tab.active {
        background: #fff;
        color: #333;
        border-bottom: 2px solid #ff6b35;
      }

      .modal-content {
        padding: 16px;
        max-height: 500px;
        overflow-y: auto;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .import-textarea {
        width: 100%;
        height: 200px;
        padding: 16px;
        border: 1px solid #d0d0d0;
        border-radius: 4px;
        font-family: "SF Mono", "Monaco", "Inconsolata", "Roboto Mono", monospace;
        font-size: 12px;
        color: #333;
        resize: vertical;
        margin-bottom: 16px;
      }

      .import-textarea:focus {
        outline: none;
        border-color: #ff6b35;
        box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
      }

      .file-drop-zone {
        border: 2px dashed #d0d0d0;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        background: #fafafa;
        transition: all 0.15s ease;
        cursor: pointer;
        margin-bottom: 16px;
      }

      .file-drop-zone:hover,
      .file-drop-zone.drag-over {
        border-color: #ff6b35;
        background: rgba(255, 107, 53, 0.05);
      }

      .file-drop-zone p {
        margin: 0;
        color: #666;
        font-size: 14px;
      }

      .file-drop-zone .file-icon {
        font-size: 32px;
        margin-bottom: 12px;
        color: #999;
      }

      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      .modal-btn {
        padding: 10px 20px;
        border: 1px solid #d0d0d0;
        border-radius: 4px;
        background: #f8f8f8;
        color: #333;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-family: inherit;
      }

      .modal-btn.primary {
        background: #ff6b35;
        border-color: #e55a2b;
        color: #fff;
      }

      .modal-btn:hover {
        background: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .modal-btn.primary:hover {
        background: #ff7849;
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
      }

      /* Share Modal Styles */
      .share-option {
        padding: 12px;
        border: 1px solid #d0d0d0;
        border-radius: 6px;
        margin-bottom: 8px;
        background: #fafafa;
        transition: all 0.15s ease;
      }

      .share-option:hover {
        background: #f0f0f0;
        border-color: #ff6b35;
      }

      .share-option.warning {
        border-color: #ffa500;
        background: #fff8f0;
      }

      .share-option.success {
        border-color: #28a745;
        background: #f0fff4;
      }

      .share-option-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .share-option-title {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin: 0;
      }

      .share-option-status {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 3px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
      }

      .share-option-status.recommended {
        background: #28a745;
        color: white;
      }

      .share-option-status.warning {
        background: #ffa500;
        color: white;
      }

      .share-option-description {
        font-size: 12px;
        color: #666;
        margin-bottom: 8px;
        line-height: 1.4;
      }

      .share-option-actions {
        display: flex;
        gap: 8px;
      }

      .share-btn-small {
        padding: 6px 12px;
        background: #f8f8f8;
        border: 1px solid #d0d0d0;
        border-radius: 3px;
        color: #333;
        font-size: 10px;
        cursor: pointer;
        transition: all 0.15s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-family: inherit;
        font-weight: 500;
      }

      .share-btn-small.primary {
        background: #ff6b35;
        border-color: #e55a2b;
        color: #fff;
      }

      .share-btn-small:hover {
        background: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .share-btn-small.primary:hover {
        background: #ff7849;
      }

      .encoded-text-preview {
        background: #f6f8fa;
        border: 1px solid #d0d7de;
        border-radius: 4px;
        padding: 8px;
        font-family: "SF Mono", "Monaco", "Inconsolata", "Roboto Mono", monospace;
        font-size: 9px;
        color: #24292e;
        word-break: break-all;
        max-height: 60px;
        overflow-y: auto;
        margin: 6px 0;
      }

      /* Footer Toolbar Styles */
      .footer-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 24px;
        background: #e8e8e8;
        border-top: 1px solid #d0d0d0;
        font-size: 11px;
        color: #666;
        flex-shrink: 0;
        height: 30px;
      }

      .footer-left {
        display: flex;
        align-items: center;
      }

      .footer-right {
        display: flex;
        align-items: center;
      }

      .stats {
        display: flex;
        gap: 16px;
        align-items: center;
      }

      .stat-item {
        font-family: "SF Mono", "Monaco", "Inconsolata", "Roboto Mono", monospace;
        font-size: 10px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 400;
      }

      .datetime {
        font-family: "SF Mono", "Monaco", "Inconsolata", "Roboto Mono", monospace;
        font-size: 10px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 400;
      }

      /* Mobile responsive */
      @media (max-width: 980px) {
        .editor-container {
          flex-direction: column;
          height: auto;
          min-height: calc(100vh - 170px);
        }

        .stats {
          gap: 12px;
        }

        .footer-toolbar {
          padding: 6px 16px;
          font-size: 9px;
        }

        .stat-item,
        .datetime {
          font-size: 9px;
        }

        .editor-panel {
          flex: none;
          border-right: none;
          border-bottom: 1px solid #d0d0d0;
          min-height: 300px;
        }

        .preview-panel {
          border-left: none;
          border-top: 1px solid #d0d0d0;
        }

        .toolbar {
          flex-direction: column;
          gap: 16px;
          align-items: stretch;
        }

        .toolbar-left,
        .toolbar-right {
          justify-content: center;
          flex-wrap: wrap;
          gap: 8px;
        }

        .nav-buttons {
          flex-wrap: wrap;
        }

        .header {
          flex-direction: column;
          gap: 16px;
          text-align: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="container" data-layout="split">
      <header class="header">
        <div class="logo">
          <div class="logo-icon"></div>
          <div>
            <h1>SÅ«perLight</h1>
            <div class="tagline">Markdown Editor</div>
          </div>
        </div>
        <nav class="nav-buttons">
          <button class="nav-btn" data-layout="code">Code</button>
          <button class="nav-btn active" data-layout="split">Split</button>
          <button class="nav-btn" data-layout="preview">Preview</button>
        </nav>
      </header>

      <div class="toolbar">
        <div class="toolbar-left">
          <button class="btn action" id="import-btn">Import</button>
          <button class="btn" id="clear-btn">Clear</button>
        </div>
        <div class="toolbar-right">
          <button class="btn action" id="save-btn">Save</button>
          <button class="btn" id="diff-btn">Diff</button>
          <button class="btn action" id="share-btn">Share</button>
        </div>
      </div>

      <div class="editor-container">
        <div class="editor-panel">
          <textarea class="editor-textarea" placeholder="# Start typing..."></textarea>
        </div>
        <div class="preview-panel">
          <p style="color: #999; font-style: italic">Preview will appear here...</p>
        </div>
      </div>

      <!-- Footer Toolbar -->
      <footer class="footer-toolbar">
        <div class="footer-left">
          <div class="stats">
            <span class="stat-item" id="char-count">Chars: 0</span>
            <span class="stat-item" id="word-count">Words: 0</span>
            <span class="stat-item" id="line-count">Lines: 0</span>
          </div>
        </div>
        <div class="footer-right">
          <div class="datetime" id="datetime">Loading...</div>
        </div>
      </footer>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="import-modal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Import Markdown</h3>
          <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-tabs">
          <button class="modal-tab active" data-tab="paste">Paste Content</button>
          <button class="modal-tab" data-tab="file">Upload File</button>
        </div>
        <div class="modal-content">
          <div class="tab-content active" id="paste-tab">
            <textarea
              class="import-textarea"
              id="import-textarea"
              placeholder="Paste your markdown content or encoded markdown here..."
            ></textarea>
            <div class="modal-actions">
              <button class="modal-btn" id="cancel-import">Cancel</button>
              <button class="modal-btn primary" id="import-paste">Import</button>
            </div>
          </div>
          <div class="tab-content" id="file-tab">
            <div class="file-drop-zone" id="file-drop-zone">
              <div class="file-icon">ðŸ“„</div>
              <p><strong>Click to select</strong> or drag and drop a markdown file</p>
              <p style="font-size: 12px; color: #999; margin-top: 8px">Supports .md and .txt files</p>
            </div>
            <input type="file" id="modal-file-input" accept=".md,.txt" style="display: none" />
            <div class="modal-actions">
              <button class="modal-btn" id="cancel-file">Cancel</button>
              <button class="modal-btn primary" id="import-file" disabled>Import</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="share-modal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Share Document</h3>
          <button class="modal-close" id="share-modal-close">&times;</button>
        </div>
        <div class="modal-content">
          <div id="share-options">
            <!-- Share options will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <script>
      // =================== Config ===================
      const START = "MDHISTORY:v1";
      const END = "END-MDHISTORY";

      // =================== Utils ===================
      const b64enc = (str) => {
        const bytes = new TextEncoder().encode(str);
        let bin = "";
        bytes.forEach((b) => (bin += String.fromCharCode(b)));
        return btoa(bin);
      };
      const b64dec = (b64) => {
        try {
          const bin = atob(b64);
          const bytes = Uint8Array.from(bin, (c) => c.charCodeAt(0));
          return new TextDecoder().decode(bytes);
        } catch {
          return "";
        }
      };

      const b64urlFromBytes = (bytes) => {
        let bin = "";
        bytes.forEach((b) => (bin += String.fromCharCode(b)));
        return btoa(bin).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
      };
      const bytesFromB64url = (b64u) => {
        let s = b64u.replace(/-/g, "+").replace(/_/g, "/");
        const pad = s.length % 4;
        if (pad) s += "====".slice(pad);
        const bin = atob(s);
        const arr = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
        return arr;
      };

      async function gzipString(str) {
        const enc = new TextEncoder().encode(str);
        const cs = new CompressionStream("gzip");
        const stream = new Blob([enc]).stream().pipeThrough(cs);
        const buf = await new Response(stream).arrayBuffer();
        return new Uint8Array(buf);
      }
      async function gunzipBytes(bytes) {
        const ds = new DecompressionStream("gzip");
        const stream = new Blob([bytes]).stream().pipeThrough(ds);
        const buf = await new Response(stream).arrayBuffer();
        return new Uint8Array(buf);
      }

      // Markdown renderer
      function mdToHtml(md) {
        let html = md.replace(/\r\n?/g, "\n");
        html = processCodeBlocks(html);
        html = processImages(html);
        html = processLinks(html);
        html = processTables(html);
        html = processHeaders(html);
        html = processTextFormatting(html);
        html = processLists(html);
        html = processBlockquotes(html);
        html = processHorizontalRules(html);
        html = processParagraphs(html);
        return html;
      }

      function processCodeBlocks(text) {
        return text.replace(/```[\w]*\n([\s\S]*?)```/g, (match, code) => {
          return `<pre><code>${esc(code)}</code></pre>`;
        });
      }

      function processImages(text) {
        return text.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (_, alt, src) => {
          return `<img src="${esc(src)}" alt="${esc(alt)}" style="max-width: 100%; height: auto;" />`;
        });
      }

      function processLinks(text) {
        return text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (_, linkText, url) => {
          return `<a href="${esc(url)}" target="_blank" rel="noopener">${esc(linkText)}</a>`;
        });
      }

      function processTables(text) {
        return text.replace(/((?:^|\n)\|.+\|(?:\n\|.+\|)*)/g, (match) => {
          const lines = match.trim().split("\n");
          if (lines.length < 2) return match;

          const headerRow = lines[0];
          const separatorRow = lines[1];
          const dataRows = lines.slice(2);

          if (!/^\|[\s\-:|]+\|$/.test(separatorRow)) return match;

          let table = "<table>\n<thead>\n<tr>";
          headerRow
            .split("|")
            .slice(1, -1)
            .forEach((cell) => {
              table += `<th>${esc(cell.trim())}</th>`;
            });
          table += "</tr>\n</thead>\n<tbody>\n";

          dataRows.forEach((row) => {
            table += "<tr>";
            row
              .split("|")
              .slice(1, -1)
              .forEach((cell) => {
                table += `<td>${esc(cell.trim())}</td>`;
              });
            table += "</tr>\n";
          });
          table += "</tbody>\n</table>";
          return table;
        });
      }

      function processHeaders(text) {
        return text
          .replace(/^###### (.*)$/gm, "<h6>$1</h6>")
          .replace(/^##### (.*)$/gm, "<h5>$1</h5>")
          .replace(/^#### (.*)$/gm, "<h4>$1</h4>")
          .replace(/^### (.*)$/gm, "<h3>$1</h3>")
          .replace(/^## (.*)$/gm, "<h2>$1</h2>")
          .replace(/^# (.*)$/gm, "<h1>$1</h1>");
      }

      function processTextFormatting(text) {
        text = text.replace(/`([^`]+)`/g, (_, code) => `<code>${esc(code)}</code>`);
        text = text.replace(/~~([^~]+)~~/g, "<del>$1</del>");
        text = text.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
        text = text.replace(/\*([^*]+)\*/g, "<em>$1</em>");
        return text;
      }

      function processLists(text) {
        text = text.replace(/(^|\n)- \[( |x)\] (.*)(?=\n|$)/g, (m, pre, checked, item) => {
          const isChecked = checked === "x" ? "checked" : "";
          return `${pre}<ul class="task-list"><li><input type="checkbox" ${isChecked} disabled> ${esc(item)}</li></ul>`;
        });

        text = text.replace(/(^|\n)(\d+)\. (.*)(?=\n(?!\d+\. )|$)/g, (m, pre, num, item) => {
          return `${pre}<ol><li>${item}</li></ol>`;
        });

        text = text.replace(/(^|\n)- (.*)(?=\n(?!- )|$)/g, (m, pre, item) => {
          return `${pre}<ul><li>${item}</li></ul>`;
        });

        text = text.replace(/<\/(ol|ul)>\n<\1>/g, "");
        return text;
      }

      function processBlockquotes(text) {
        text = text.replace(/(^|\n)> (.*)(?=\n(?!> )|$)/g, (m, pre, quote) => {
          return `${pre}<blockquote><p>${quote}</p></blockquote>`;
        });
        text = text.replace(/<\/blockquote>\n<blockquote>/g, "");
        return text;
      }

      function processHorizontalRules(text) {
        return text.replace(/^(---+|___+|\*\*\*+)$/gm, "<hr>");
      }

      function processParagraphs(text) {
        return text.replace(
          /(^|\n)(?!<h\d|<ul|<ol|<pre>|<table|<blockquote|<hr|<\/|<code>)([^\n]+)(?=\n|$)/g,
          (m, pre, line) => {
            if (!line.trim()) return m;
            return `${pre}<p>${line}</p>`;
          }
        );
      }

      const esc = (x) => x.replace(/[&<>]/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[m]));

      // History functions (simplified for this example)
      function extractHistoryBlock(md) {
        const re = new RegExp(`<!--\\s*${START}[\\s\\S]*?${END}\\s*-->\\s*$`);
        const m = md.match(re);
        return m ? m[0] : null;
      }
      function stripHistory(md) {
        const blk = extractHistoryBlock(md);
        return blk ? md.slice(0, md.lastIndexOf(blk)).trimEnd() : md.trimEnd?.() ?? md;
      }

      // =================== App State ===================
      let currentMd = `# SÅ«perLight âš¡

A clean, fast markdown editor with real-time preview and sharing.

## Key Features
- **Real-time preview** - See changes instantly as you type
- **Split-screen editing** - Code and preview side-by-side  
- **Easy sharing** - Generate shareable links
- **Snapshot system** - Save document versions
- **Mobile-friendly** - Works great on any device

![Coding workspace](https://images.unsplash.com/photo-1504707748692-419802cf939d?w=800&h=400&fit=crop)

*Start typing to replace this content and create your own markdown documents!*`;

      let loadedFilename = "SÅ«perLight.md";

      // =================== DOM Elements ===================
      const container = document.querySelector(".container");
      const textarea = document.querySelector(".editor-textarea");
      const preview = document.querySelector(".preview-panel");
      const navButtons = document.querySelectorAll(".nav-btn");

      // Footer elements
      const charCountEl = document.getElementById("char-count");
      const wordCountEl = document.getElementById("word-count");
      const lineCountEl = document.getElementById("line-count");
      const datetimeEl = document.getElementById("datetime");
      const importBtn = document.getElementById("import-btn");
      const clearBtn = document.getElementById("clear-btn");
      const saveBtn = document.getElementById("save-btn");
      const diffBtn = document.getElementById("diff-btn");
      const shareBtn = document.getElementById("share-btn");

      // Modal elements
      const importModal = document.getElementById("import-modal");
      const modalClose = document.getElementById("modal-close");
      const modalTabs = document.querySelectorAll(".modal-tab");
      const importTextarea = document.getElementById("import-textarea");
      const importPasteBtn = document.getElementById("import-paste");
      const cancelImportBtn = document.getElementById("cancel-import");
      const fileDropZone = document.getElementById("file-drop-zone");
      const modalFileInput = document.getElementById("modal-file-input");
      const importFileBtn = document.getElementById("import-file");
      const cancelFileBtn = document.getElementById("cancel-file");

      // Share modal elements
      const shareModal = document.getElementById("share-modal");
      const shareModalClose = document.getElementById("share-modal-close");
      const shareOptions = document.getElementById("share-options");

      // =================== Functions ===================
      function renderAll() {
        const visible = stripHistory(currentMd);
        preview.innerHTML = mdToHtml(visible);
        updateStats();
      }

      function updateStats() {
        const text = currentMd;
        const chars = text.length;
        const words = text.trim() === "" ? 0 : text.trim().split(/\s+/).length;
        const lines = text === "" ? 0 : text.split("\n").length;

        charCountEl.textContent = `Chars: ${chars}`;
        wordCountEl.textContent = `Words: ${words}`;
        lineCountEl.textContent = `Lines: ${lines}`;
      }

      function updateDateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString("en-US", {
          hour12: false,
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
        const dateString = now.toLocaleDateString("en-US", {
          weekday: "short",
          month: "short",
          day: "numeric",
          year: "numeric",
        });
        datetimeEl.textContent = `${dateString} ${timeString}`;
      }

      function setLayout(layout) {
        container.dataset.layout = layout;
        navButtons.forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.layout === layout);
        });
      }

      // Modal functions
      function showModal() {
        importModal.classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function hideModal() {
        importModal.classList.remove("active");
        document.body.style.overflow = "";
        // Reset modal state
        importTextarea.value = "";
        modalFileInput.value = "";
        importFileBtn.disabled = true;
        setActiveTab("paste");
      }

      function setActiveTab(tabName) {
        modalTabs.forEach((tab) => {
          tab.classList.toggle("active", tab.dataset.tab === tabName);
        });
        document.getElementById("paste-tab").classList.toggle("active", tabName === "paste");
        document.getElementById("file-tab").classList.toggle("active", tabName === "file");
      }

      function tryDecodeContent(content) {
        // Try to decode if it looks like encoded content
        if (content.startsWith("MDLITE:")) {
          try {
            const [tag, rest] = content.split("|", 2);
            const restAll = content.slice(tag.length + 1);
            if (restAll.startsWith("b64|")) {
              const data = restAll.slice("b64|".length);
              return b64dec(data);
            } else if (restAll.startsWith("gz-b64url|")) {
              // For now, return original content - async decoding would need different handling
              return content;
            }
          } catch (e) {
            console.warn("Failed to decode content", e);
          }
        }
        return content;
      }

      // Share modal functions
      function showShareModal() {
        shareModal.classList.add("active");
        document.body.style.overflow = "hidden";
        generateShareOptions();
      }

      function hideShareModal() {
        shareModal.classList.remove("active");
        document.body.style.overflow = "";
      }

      async function generateShareOptions() {
        const contentToShare = currentMd;
        const options = [];

        try {
          // Option 1: Direct URL (best case)
          let directUrl = "";
          let directPayload = "";

          if ("CompressionStream" in window && "DecompressionStream" in window) {
            const gz = await gzipString(contentToShare);
            directPayload = `MDLITE:v1|gz-b64url|` + b64urlFromBytes(gz);
          } else {
            directPayload = `MDLITE:v1|b64|` + b64enc(contentToShare);
          }

          directUrl = location.origin + location.pathname + "#" + directPayload;

          if (directUrl.length <= 2000) {
            options.push({
              title: "Shareable Link",
              status: "recommended",
              statusClass: "recommended",
              description: "Perfect size for all messengers and social platforms. Click to copy link.",
              type: "url",
              payload: directUrl,
              className: "success",
            });
          } else if (directUrl.length <= 8000) {
            options.push({
              title: "Shareable Link",
              status: "warning",
              statusClass: "warning",
              description: "May not work in some messengers (WhatsApp, SMS). Works in most other platforms.",
              type: "url",
              payload: directUrl,
              className: "warning",
            });
          }

          // Option 2: Encoded text (always available)
          options.push({
            title: "Encoded Text",
            status: contentToShare.length > 3000 ? "recommended" : "",
            statusClass: contentToShare.length > 3000 ? "recommended" : "",
            description: "Copy encoded text to share via any messenger. Recipient pastes into Import â†’ Paste Content.",
            type: "encoded",
            payload: directPayload,
            className: "",
          });

          // Option 3: File download (always available) - more compact
          options.push({
            title: "Download File",
            status: "",
            statusClass: "",
            description: "Save as .md file for email or cloud sharing.",
            type: "file",
            payload: contentToShare,
            className: "",
          });
        } catch (e) {
          console.error("Error generating share options:", e);
        }

        renderShareOptions(options);
      }

      function renderShareOptions(options) {
        shareOptions.innerHTML = options
          .map(
            (option, index) => `
          <div class="share-option ${option.className}">
            <div class="share-option-header">
              <h4 class="share-option-title">${option.title}</h4>
              ${option.status ? `<span class="share-option-status ${option.statusClass}">${option.status}</span>` : ""}
            </div>
            <p class="share-option-description">${option.description}</p>
            ${
              option.type === "encoded"
                ? `
              <div class="encoded-text-preview">${option.payload.substring(0, 100)}${
                    option.payload.length > 100 ? "..." : ""
                  }</div>
            `
                : ""
            }
            <div class="share-option-actions">
              ${
                option.type === "url"
                  ? `
                <button class="share-btn-small primary" onclick="copyToClipboard('${option.payload.replace(
                  /'/g,
                  "\\'"
                )}', 'Link copied!')">Copy Link</button>
              `
                  : ""
              }
              ${
                option.type === "encoded"
                  ? `
                <button class="share-btn-small primary" onclick="copyToClipboard('${option.payload.replace(
                  /'/g,
                  "\\'"
                )}', 'Encoded text copied!')">Copy Text</button>
              `
                  : ""
              }
              ${
                option.type === "file"
                  ? `
                <button class="share-btn-small primary" onclick="downloadFile()">Download</button>
              `
                  : ""
              }
            </div>
          </div>
        `
          )
          .join("");
      }

      async function copyToClipboard(text, successMessage) {
        try {
          await navigator.clipboard.writeText(text);
          // Show brief success feedback
          const originalContent = event.target.textContent;
          event.target.textContent = "Copied!";
          event.target.style.background = "#28a745";
          setTimeout(() => {
            event.target.textContent = originalContent;
            event.target.style.background = "";
          }, 1500);
        } catch (e) {
          // Fallback for older browsers
          const textArea = document.createElement("textarea");
          textArea.value = text;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand("copy");
          document.body.removeChild(textArea);
          alert(successMessage);
        }
      }

      function downloadFile() {
        const blob = new Blob([currentMd], { type: "text/markdown" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = loadedFilename.endsWith(".md") ? loadedFilename : "document.md";
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(a.href), 1000);
      }

      // =================== Event Listeners ===================
      textarea.addEventListener("input", function () {
        currentMd = this.value;
        renderAll();
      });

      // Layout switching
      navButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          setLayout(btn.dataset.layout);
        });
      });

      // New button functionality
      importBtn.addEventListener("click", () => {
        showModal();
      });

      clearBtn.addEventListener("click", () => {
        if (confirm("Are you sure you want to clear all content? This cannot be undone.")) {
          loadedFilename = "document.md";
          currentMd = "";
          textarea.value = currentMd;
          renderAll();
        }
      });

      // Modal event listeners
      modalClose.addEventListener("click", hideModal);
      cancelImportBtn.addEventListener("click", hideModal);
      cancelFileBtn.addEventListener("click", hideModal);

      // Share modal event listeners
      shareModalClose.addEventListener("click", hideShareModal);

      // Close modal on overlay click
      importModal.addEventListener("click", (e) => {
        if (e.target === importModal) {
          hideModal();
        }
      });

      shareModal.addEventListener("click", (e) => {
        if (e.target === shareModal) {
          hideShareModal();
        }
      });

      // Tab switching
      modalTabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          setActiveTab(tab.dataset.tab);
        });
      });

      // Paste import functionality
      importPasteBtn.addEventListener("click", () => {
        const content = importTextarea.value.trim();
        if (!content) return;

        const decodedContent = tryDecodeContent(content);
        currentMd = decodedContent;
        textarea.value = currentMd;
        renderAll();
        hideModal();
      });

      // File drop zone functionality
      fileDropZone.addEventListener("click", () => {
        modalFileInput.click();
      });

      fileDropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        fileDropZone.classList.add("drag-over");
      });

      fileDropZone.addEventListener("dragleave", () => {
        fileDropZone.classList.remove("drag-over");
      });

      fileDropZone.addEventListener("drop", async (e) => {
        e.preventDefault();
        fileDropZone.classList.remove("drag-over");

        const files = Array.from(e.dataTransfer.files);
        const file = files.find((f) => f.name.endsWith(".md") || f.name.endsWith(".txt"));

        if (file) {
          loadedFilename = file.name;
          const text = await file.text();
          currentMd = text;
          textarea.value = currentMd;
          renderAll();
          hideModal();
        }
      });

      modalFileInput.addEventListener("change", async (e) => {
        const file = e.target.files?.[0];
        if (!file) {
          importFileBtn.disabled = true;
          return;
        }
        importFileBtn.disabled = false;
      });

      importFileBtn.addEventListener("click", async () => {
        const file = modalFileInput.files?.[0];
        if (!file) return;

        loadedFilename = file.name;
        const text = await file.text();
        currentMd = text;
        textarea.value = currentMd;
        renderAll();
        hideModal();
      });

      // New share functionality
      shareBtn.addEventListener("click", () => {
        showShareModal();
      });

      // Diff functionality (simplified to current vs last snapshot)
      diffBtn.addEventListener("click", () => {
        // For now, show a simple diff indication
        // This would need to be implemented based on your snapshot system
        alert(
          "Diff functionality: Compare current content with last saved snapshot.\nThis feature needs to be integrated with your snapshot/history system."
        );
      });

      // Keyboard support
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          if (shareModal.classList.contains("active")) {
            hideShareModal();
          } else if (importModal.classList.contains("active")) {
            hideModal();
          }
        }
      });

      // Button animations
      document.querySelectorAll(".btn, .nav-btn").forEach((btn) => {
        btn.addEventListener("mousedown", function () {
          this.style.transform = "scale(0.98)";
        });

        btn.addEventListener("mouseup", function () {
          this.style.transform = "scale(1)";
        });
      });

      // =================== Initialize ===================
      textarea.value = currentMd;
      renderAll();

      // Initialize and start the clock
      updateDateTime();
      setInterval(updateDateTime, 1000);

      // Load from hash if present
      (async function initFromHash() {
        const h = location.hash.slice(1);
        if (!h || !h.startsWith("MDLITE:")) return;

        try {
          const [tag, rest] = h.split("|", 2);
          const restAll = h.slice(tag.length + 1);
          if (restAll.startsWith("gz-b64url|")) {
            const data = restAll.slice("gz-b64url|".length);
            const bytes = await gunzipBytes(bytesFromB64url(data));
            const text = new TextDecoder().decode(bytes);
            currentMd = text;
            textarea.value = currentMd;
            renderAll();
            setLayout("preview");
          } else if (restAll.startsWith("b64|")) {
            const data = restAll.slice("b64|".length);
            currentMd = b64dec(data);
            textarea.value = currentMd;
            renderAll();
            setLayout("preview");
          }
          history.replaceState(null, "", location.pathname + location.search);
        } catch (e) {
          console.warn("Failed to parse shared payload", e);
        }
      })();
    </script>
  </body>
</html>
